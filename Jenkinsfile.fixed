pipeline {
    agent any
    
    stages {
        stage('æ£€å‡ºä»£ç ') {
            steps {
                echo 'æ£€å‡ºä»£ç ...'
                checkout scm
            }
        }
        
        stage('æ£€æŸ¥ç¯å¢ƒ') {
            steps {
                echo 'æ£€æŸ¥Javaå’ŒMavenç¯å¢ƒ...'
                script {
                    if (isUnix()) {
                        sh 'java -version'
                        sh 'mvn -version'
                    } else {
                        bat 'java -version'
                        bat 'mvn -version'
                    }
                }
            }
        }
        
        stage('ç¼–è¯‘') {
            steps {
                echo 'ç¼–è¯‘é¡¹ç›®...'
                script {
                    if (isUnix()) {
                        sh 'mvn clean compile'
                    } else {
                        bat 'mvn clean compile'
                    }
                }
            }
        }
        
        stage('æµ‹è¯•') {
            steps {
                echo 'è¿è¡Œæµ‹è¯•...'
                script {
                    if (isUnix()) {
                        sh 'mvn test'
                    } else {
                        bat 'mvn test'
                    }
                }
            }
            post {
                always {
                    script {
                        if (fileExists('target/surefire-reports/TEST-*.xml')) {
                            junit 'target/surefire-reports/TEST-*.xml'
                        } else {
                            echo 'æœªæ‰¾åˆ°æµ‹è¯•ç»“æœæ–‡ä»¶'
                        }
                    }
                }
            }
        }
        
        stage('æ‰“åŒ…') {
            steps {
                echo 'æ‰“åŒ…åº”ç”¨...'
                script {
                    if (isUnix()) {
                        sh 'mvn package -DskipTests'
                    } else {
                        bat 'mvn package -DskipTests'
                    }
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('éƒ¨ç½²æµ‹è¯•') {
            steps {
                echo 'å¯åŠ¨åº”ç”¨è¿›è¡Œæµ‹è¯•...'
                script {
                    if (isUnix()) {
                        sh '''
                            echo "å¯åŠ¨Spring Bootåº”ç”¨..."
                            nohup java -jar target/jenkins-test-1.0.0.jar --server.port=8081 > app.log 2>&1 &
                            sleep 10
                            echo "æµ‹è¯•åº”ç”¨æ˜¯å¦å¯åŠ¨æˆåŠŸ..."
                            if command -v curl >/dev/null 2>&1; then
                                curl -f http://localhost:8081/health || exit 1
                                echo "åº”ç”¨å¯åŠ¨æˆåŠŸï¼"
                            else
                                echo "curlå‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"
                            fi
                        '''
                    } else {
                        bat '''
                            echo å¯åŠ¨Spring Bootåº”ç”¨...
                            start /B java -jar target\\jenkins-test-1.0.0.jar --server.port=8081
                            timeout /T 10
                            echo æµ‹è¯•åº”ç”¨å¥åº·æ£€æŸ¥...
                            where curl >nul 2>&1
                            if %errorlevel%==0 (
                                curl -f http://localhost:8081/health || exit 1
                                echo åº”ç”¨å¯åŠ¨æˆåŠŸï¼
                            ) else (
                                echo curlå‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡å¥åº·æ£€æŸ¥
                            )
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'æ„å»ºæµç¨‹å®Œæˆ'
            script {
                if (isUnix()) {
                    sh 'pkill -f "jenkins-test-1.0.0.jar" || true'
                } else {
                    bat 'taskkill /F /IM java.exe || exit 0'
                }
            }
        }
        success {
            echo 'ğŸ‰ æ„å»ºæˆåŠŸï¼åº”ç”¨å·²é€šè¿‡æ‰€æœ‰æµ‹è¯•'
        }
        failure {
            echo 'âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—'
        }
    }
}
