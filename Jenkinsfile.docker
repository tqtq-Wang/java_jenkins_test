pipeline {
    agent {
        docker {
            image 'openjdk:17-jdk-slim'
            args '-v /var/run/docker.sock:/var/run/docker.sock'
        }
    }
    
    stages {
        stage('å‡†å¤‡ç¯å¢ƒ') {
            steps {
                echo 'å®‰è£…Maven...'
                sh '''
                    apt-get update
                    apt-get install -y maven curl
                '''
            }
        }
        
        stage('æ£€å‡ºä»£ç ') {
            steps {
                echo 'æ£€å‡ºä»£ç ...'
                checkout scm
            }
        }
        
        stage('ç¼–è¯‘å’Œæµ‹è¯•') {
            steps {
                echo 'ç¼–è¯‘å’Œæµ‹è¯•é¡¹ç›®...'
                sh '''
                    mvn clean compile
                    mvn test
                    mvn package -DskipTests
                '''
            }
            post {
                always {
                    publishTestResults testResultsPattern: 'target/surefire-reports/*.xml'
                }
                success {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('å¥åº·æ£€æŸ¥') {
            steps {
                echo 'éªŒè¯æ„å»ºäº§ç‰©...'
                sh '''
                    ls -la target/
                    echo "å¯åŠ¨åº”ç”¨è¿›è¡Œå¥åº·æ£€æŸ¥..."
                    java -jar target/jenkins-test-1.0.0.jar --server.port=8081 &
                    APP_PID=$!
                    sleep 15
                    curl -f http://localhost:8081/health || exit 1
                    kill $APP_PID
                    echo "å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                '''
            }
        }
    }
    
    post {
        always {
            echo 'æ¸…ç†ç¯å¢ƒ...'
        }
        success {
            echo 'ğŸ‰ Dockerç¯å¢ƒä¸‹æ„å»ºæˆåŠŸï¼'
        }
        failure {
            echo 'âŒ Dockerç¯å¢ƒä¸‹æ„å»ºå¤±è´¥'
        }
    }
}
